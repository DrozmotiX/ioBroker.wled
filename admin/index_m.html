<html>

<head>
	<!-- Load ioBroker scripts and styles-->
	<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

	<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

	<script type="text/javascript" src="../../js/translate.js"></script>
	<script type="text/javascript" src="../../lib/js/materialize.js"></script>
	<script type="text/javascript" src="../../js/adapter-settings.js"></script>

	<!-- Load our own files -->
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="words.js"></script>

	<script type="text/javascript">

		let _onChange;



		function loadTable(obj){
			let  index = 1;
			let text = '';

			// console.log('Data for table ' + JSON.stringify(obj))
            for(i in obj) {
				if (obj[i] !== undefined) {
                        // index = obj[i].value.native.ip
                        // text += '<tr id="' + index + '"><td><span id="' + index + '-index">' + index + '</span></td>'
                        text += '<tr id="' + obj[i].value.native.ip + '"><td><span id="' + obj[i].value.native.ip + '-index">' + obj[i].value.native.ip + '</span></td>'
						text += '<td> <input id="'+ index + '-Name" type="text" disabled="true" class="center-align input-field" value=' + obj[i].value.native.name + '></td>'
						text += '<td> <input id="' + index + '-ip" type="text" disabled="true" class="center-align input-field" value="' + obj[i].value.native.ip + '"></td>'
						// text += '<td>' + '' +
						// 	'<a id="' + index + '-delete" class="delete-device values-buttons btn-floating btn-small waves-effect waves-light red"><i class="material-icons" title="Delete device">delete</i></a>';
						text += '</select></td></tr>';

						index = (index + 1);
					}

				}

                $('#devices').append(text);

                $('input, .delete-device').each(function () {
                    let $key = $(this);

                    $key.on('click', function () {
                        _onChange();
                    }).keyup(function () {
                        _onChange();
                    });

                    $key.change(function () {
                        _onChange();
                    }).keyup(function () {
                        _onChange();
                    });
                });
		}


		function add_row(){
            let index = $('tr').length;
            // index = ""
			//TODO: add overwrite protection for existing index number if a previous device was removed from the list

			let text = '';

					text += '<tr id="' + index + '" class="delete-device"><td><span id="'+ index + '-index">' + index + '</span></td>'
					text += '<td> <input id="'+ index + '-Name" type="text" disabled="true" class="center-align input-field" value="<will be automatically detected>"></td>'
					text += '<td> <input id="'+ index + '-ip" type="text" class="center-align input-field" value="192.168.xxx.xxx"></td>'
					// text += '<td>' + '' +
					// 	'<a id="'+ index + '-delete" class="delete-device values-buttons btn-floating btn-small waves-effect waves-light red"><i class="material-icons" title="Delete device">delete</i></a>';
					text += '</select></td></tr>';

            $('#devices').append(text);
            
            $('#devices_new').append(text);


            $('input').each(function () {
                let $key = $(this);

                $key.on('click', function(){
                    _onChange();
                }).keyup(function() {
                    _onChange();
                });

                $key.change(function() {
                    _onChange();
                }).keyup(function() {
                    _onChange();
                });
            });

            M.updateTextFields();
		}


		// This will be called by the admin adapter when the settings page loads
        function load(settings, onChange) {
            _onChange = onChange;
            // example: select elements with id=key and class=value and insert value
            if (!settings) return;
            $('.value').each(function () {
                let $key = $(this);
                let id = $key.attr('id');
                if ($key.attr('type') === 'checkbox') {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.prop('checked', settings[id])
                        .on('change', () => onChange())
                        ;
                } else {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.val(settings[id])
                        .on('change', () => onChange())
                        .on('keyup', () => onChange())
                }
			});
            emitDevices();
			onChange(false);
			
			$('#add-device').click(function(){
			add_row();
			});
			$(document).on('click', '[id$=-delete]', function(obj){
                let id = obj.currentTarget.id;
                id = id.replace('-delete', '');
                $('#' + id).remove();
                onChange();
            });
            // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
            M.updateTextFields();
        }

		// This will be called by the admin adapter when the user presses the save button
		function save(callback) {
			let obj = {};
            let i = 0;
            $('tbody > tr').each(function(){
                i = i+1;
                let ip = $('#' + i + '-ip').val();
                console.log('IP : ' + JSON.stringify(ip));

                // let encrypted = encrypt(secret, password);

                if(!obj.devices){
                    obj.devices = {1:{ip: ip}};
                    obj.devices = {[ip]:{ip: ip}};
                    // obj.devices[ip] = {ip: ip};
                }else{
                    obj.devices[ip] = {ip: ip};
                }

                console.log(JSON.stringify(obj));
            });
            console.log('index: ' + i);


        callback(obj);
	  }

	  function emitDevices(){
            socket.emit('getObjectView', 'system', 'device', { startkey: 'wled.' + instance + '.',  endkey: 'wled.' + instance + '.\u9999', include_docs: true }, function (err, _devices) {
                socket.emit('getStates', function (err, _values) {
                    let namespace = 'wled.' + instance + '.';
					let len = namespace.length;
                    if (_devices && _devices.rows && _devices.rows.length) {
						console.log('Loopje : ' + len );
						loadTable(_devices.rows);
                    }
                });
            });
        }

	</script>

</head>

<body>

	<div class="m adapter-container">

		<div class="row">
			<div class="input-field col s6 m4 l6">
				<img src="wled.png" class="logo">
			</div>
		</div>
		<div class="section">
			<h6 class="translate">Devices are automatically detected and listend here! To-Do : Add manually</h6>
            <!--
		<div class="row">
				<a id="add-device" class="table-button-add waves-effect waves-light btn blue translate"><i class="large left material-icons">add_circle</i>Add Device</a>
		</div>
            -->
        <div class="col s10 m10 l10 xl10 row">
			<div class="table-values-div">
                <table class="table-values centered">
                    <thead>
						<tr>
							<th class="translate" >ID</th>
							<th class="translate" >Name</th>
                            <th class="translate" >IP</th>
                            <!--
                            <th class="translate">Remove</th>
                            -->
						</tr>
                    </thead>
					<tbody id="devices"></tbody>	
                </table>
			</div>
		</div>

	</div>

</body>

</html>	